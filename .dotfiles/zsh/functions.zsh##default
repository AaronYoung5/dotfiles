#!/usr/bin/env zsh

function pseudo() {
  local profile_name="$1"
  
  if [[ -z "$profile_name" ]]; then
    echo "Usage: pseudo <profile-name>"
    echo ""
    pseudo-list
    return 1
  fi
  
  if [[ ! -f ~/.dotfiles/zsh/profiles/${profile_name}.zsh ]]; then
    echo "Error: Profile '$profile_name' not found"
    echo ""
    pseudo-list
    return 1
  fi
  
  local user_home=$(zsh -c "source ~/.dotfiles/zsh/profiles/${profile_name}.zsh >/dev/null 2>&1; echo \$USER_HOME")
  local pseudo_user=$(zsh -c "source ~/.dotfiles/zsh/profiles/${profile_name}.zsh >/dev/null 2>&1; echo \$PSEUDO_USER")
  local session_name=$(zsh -c "source ~/.dotfiles/zsh/profiles/${profile_name}.zsh >/dev/null 2>&1; echo \$TMUX_SESSION_NAME")
  
  if [[ -n "$session_name" ]] && [[ -n "$user_home" ]] && [[ -z "$TMUX" ]]; then
    local socket_path="$user_home/.tmux_socket"
    USER_HOME="$user_home" PSEUDO_USER="$pseudo_user" TMUX_SESSION_NAME="$session_name" tmux -S "$socket_path" new-session -A -s "$session_name" -c "$user_home"
  else
    echo "Error: Cannot start session (missing profile vars or already in tmux)" >&2
    return 1
  fi
}

function pseudo-list() {
  echo "Available profiles:"
  if [[ -d ~/.dotfiles/zsh/profiles ]]; then
    ls -1 ~/.dotfiles/zsh/profiles 2>/dev/null | sed 's/\.zsh$//' | sed 's/##.*$//' | sort -u | sed 's/^/  - /' || echo "  (none)"
  else
    echo "  (none)"
  fi
  
  echo "\nShort aliases:"
  if [[ -f ~/.dotfiles/zsh/aliases.local.zsh ]]; then
    grep "^alias.*=.*pseudo " ~/.dotfiles/zsh/aliases.local.zsh | sed 's/^/  /' || echo "  (none)"
  else
    echo "  (none)"
  fi
}

function pseudo-alias() {
  local short_name="$1"
  local profile_name="$2"
  
  if [[ -z "$short_name" ]] || [[ -z "$profile_name" ]]; then
    echo "Usage: pseudo-alias <short-name> <profile-name>"
    echo "Example: pseudo-alias p personal"
    return 1
  fi
  
  mkdir -p ~/.dotfiles/zsh
  echo "alias $short_name='pseudo $profile_name'" >> ~/.dotfiles/zsh/aliases.local.zsh
  echo "âœ“ Created alias: $short_name -> pseudo $profile_name"
  echo "  (Reload shell or run: source ~/.zshrc)"
}

function pseudo-init-commands() {
  [[ ! -d ~/.dotfiles/zsh/profiles ]] && return
  
  for profile_file in ~/.dotfiles/zsh/profiles/*.zsh(N); do
    [[ "$profile_file" == *"##"* ]] && continue
    [[ ! -L "$profile_file" ]] && continue
    
    local profile_name="${${profile_file:t}%.zsh}"
    [[ -z "$profile_name" ]] && continue
    command -v "$profile_name" &>/dev/null && continue
    
    eval "function $profile_name() { pseudo '$profile_name'; }"
  done
}