#!/usr/bin/env sh

# Only for pseudo configs
if [ -z "${PSEUDO_USER}" ]; then
  exit 0
fi

DIR=$(cd "$(dirname -- "$0")" && pwd)
. ${DIR}/helpers.sh

if check_command micromamba >/dev/null 2>&1; then
  MAMBA=$(readlink -f micromamba)
  if confirm "`micromamba` found, should I symlink it to `mamba`?"; then
    sudo ln -s ${MAMBA} ${MAMBA:h}/mamba
  fi
elif check_command mamba >/dev/null 2>&1; then
  MAMBA=$(readlink -f mamba)
elif check_command conda >/dev/null 2>&1; then
  MAMBA=$(readlink -f mamba)
else
    echo "Mamba isn't installed. Ignoring..."
    exit 0
fi

# Create a mamba environment with the same name as the pseudo user
# Only create if it doesn't exist
if [ -d ${USER_HOME}/.conda/envs/${PSEUDO_USER} ]; then
  echo "Mamba environment already exists at ${USER_HOME}/.conda/envs/${PSEUDO_USER}"
else
  echo "Creating mamba environment at ${USER_HOME}/.conda/envs/${PSEUDO_USER}"
  ${MAMBA} env create -p ${USER_HOME}/.conda/envs/${PSEUDO_USER}
fi
