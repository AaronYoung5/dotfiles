#!/usr/bin/env zsh

if [ ! -f .direnv/.gitignore ]; then
    echo "*" > .direnv/.gitignore
fi

layout_mamba() {
    mamba="mamba"
    if command -v micromamba >/dev/null 2>&1; then
      mamba="micromamba"
    fi
    eval "$(${mamba} shell hook --shell zsh)"

    local python_version=""
    local env_name=""

    while [[ "$#" -gt 0 ]]; do
        case "$1" in
            --python)
                shift
                python_version="$1"
                ;;
            *)
                [[ -z "$env_name" ]] && env_name="$1"
                ;;
        esac
        shift
    done

    if [[ -z "$env_name" ]]; then
        if [[ -f environment.yml ]]; then
            env_name=$(grep "^name:" environment.yml | sed -e 's/name: //')
        else
            env_name=$(basename "$PWD")
        fi
    fi

    local env_dir="$PWD/.direnv"
    local env_path="$env_dir/mamba-$env_name"
    mkdir -p "$env_dir"

    if [[ ! -d "$env_path" ]]; then
        echo "Local environment '$env_name' not found; creating at $env_path..."
        if [[ -f environment.yml ]]; then
            if [[ -n "$python_version" ]]; then
                ${mamba} create --yes --prefix "$env_path" python="$python_version"
                ${mamba} env update --prefix "$env_path" --file environment.yml --prune
            else
                ${mamba} env create --prefix "$env_path" --file environment.yml
            fi
        else
            if [[ -n "$python_version" ]]; then
                ${mamba} create --yes --prefix "$env_path" python="$python_version"
            else
                ${mamba} create --yes --prefix "$env_path"
            fi
        fi
    fi

    ${mamba} activate "$env_path"

    export CONDA_PROMPT_MODIFIER=$env_name
}

