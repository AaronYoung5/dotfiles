#!/usr/bin/env zsh

# Go to USER_HOME if set (for pseudo users and tmux panes/windows)
if [[ -n "$USER_HOME" ]]; then
  cd "$USER_HOME"
fi

# Dotfiles configuration - auto-detect location
if [[ -d "$HOME/.dotfiles/zsh" ]]; then
  export DOTFILES_DIR="$HOME/.dotfiles"
elif [[ -d "$HOME/zsh" ]]; then
  export DOTFILES_DIR="$HOME"
else
  export DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"
fi
export PSEUDOS_DIR="${PSEUDOS_DIR:-$HOME/Pseudos}"

# Load exports, aliases, and functions
[[ -f ~/.dotfiles/zsh/exports.zsh ]] && source ~/.dotfiles/zsh/exports.zsh
[[ -f ~/.dotfiles/zsh/aliases.zsh ]] && source ~/.dotfiles/zsh/aliases.zsh
[[ -f ~/.dotfiles/zsh/functions.zsh ]] && source ~/.dotfiles/zsh/functions.zsh

# Load user's local customizations
[[ -f ~/.dotfiles/zsh/aliases.local.zsh ]] && source ~/.dotfiles/zsh/aliases.local.zsh

# Enable Powerlevel10k instant prompt. 
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Set the directory we want to store zgen and plugins
ZGEN_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zgen"

# Download zgen, if it's not there yet
if [ ! -d "${ZGEN_HOME}" ]; then
    mkdir -p "$(dirname ${ZGEN_HOME})"
    git clone https://github.com/tarjoilija/zgen.git "${ZGEN_HOME}"
fi

# load zgen
source "${ZGEN_HOME}/zgen.zsh"

# if the init script doesn't exist
if ! zgen saved; then
    zgen prezto
    zgen prezto archive
    zgen prezto autosuggestions
    zgen prezto completion
    zgen prezto git
    zgen load zsh-users/zsh-syntax-highlighting
    zgen save
fi

# Load completions
autoload -Uz compinit && compinit

# zsh theme
# To customize prompt, run `p10k configure` or edit ~/.config/zsh/p10k.zsh.
[[ ! -f ~/.dotfiles/zsh/p10k.zsh ]] || source ~/.dotfiles/zsh/p10k.zsh
autoload -U promptinit
promptinit
prompt powerlevel10k

# Simple prompt (customize as needed)
PS1='%F{blue}%~%f %# '

# Docker container indicator
if [[ -f /.dockerenv ]] || grep -q docker /proc/1/cgroup 2>/dev/null; then
  PS1='%F{cyan}[docker]%f %F{blue}%~%f %# '
fi

# Pseudo user indicator in prompt when active
if [[ -n "$PSEUDO_USER" ]]; then
  if [[ -f /.dockerenv ]] || grep -q docker /proc/1/cgroup 2>/dev/null; then
    PS1='%F{cyan}[docker]%f %F{yellow}[$PSEUDO_USER]%f %F{blue}%~%f %# '
  else
    PS1='%F{yellow}[$PSEUDO_USER]%f %F{blue}%~%f %# '
  fi
fi

# Conditionally load the brew shellenv
if [ -f "/opt/homebrew/bin/brew" ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi
